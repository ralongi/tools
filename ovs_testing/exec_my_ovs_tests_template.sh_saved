#!/bin/bash

dbg_flag=${dbg_flag:-"set +x"}
$dbg_flag
#RHEL_VER=${RHEL_VER:-""}
RHEL_VER_MAJOR=$(echo $RHEL_VER | awk -F "." '{print $1}')
SELINUX=${SELINUX:-"yes"}
COMPOSE=${COMPOSE:-""}
GUEST_IMG_VALUE=$RHEL_VER
/home/ralongi/gvar/bin/gvar $COMPOSE

if [[ $brew_build ]]; then export brew_build_cmd="-B $brew_build"; fi

# Script to execute all of my ovs tests

source ~/git/kernel/networking/openvswitch/common/package_list.sh > /dev/null
source ~/.bashrc > /dev/null

use_hpe_synergy=${use_hpe_synergy:-"no"}

sedeasy ()
{
sed -i "s/$(echo $1 | sed -e 's/\([[\/.*]\|\]\)/\\&/g')/$(echo $2 | sed -e 's/[\/&]/\\&/g')/g" $3
}

netscout_cable()
{
	rhel_version=$(cut -f1 -d. /etc/redhat-release | sed 's/[^0-9]//g')
	local port1=$(echo $1 | tr '[:lower:]' '[:upper:]')
	local port2=$(echo $2 | tr '[:lower:]' '[:upper:]')
	# possible netscout switches: bos_3200  bos_3903  nay_3200  nay_3901
	# set this in runtest.sh as necessary
	netscout_switch=${netscout_switch:-"bos_3903"}
	
	if [[ "$rhel_version" -eq 8 ]]; then
		pushd /home/NetScout/
		rm -f settings.cfg
		wget -O ./settings.cfg http://netqe-infra01.knqe.lab.eng.bos.redhat.com/NSConn/"$netscout_switch".cfg
		sleep 2
		python3 /home/ralongi/github/NetScout/NSConnect.py --connect $port1 $port2
		popd
	elif [[ "$rhel_version" -eq 7 ]]; then	
		scl enable rh-python34 - << EOF
			pushd /home/NetScout/
			rm -f settings.cfg
			wget -O ./settings.cfg http://netqe-infra01.knqe.lab.eng.bos.redhat.com/NSConn/"$netscout_switch".cfg
			sleep 2
			python /home/ralongi/github/NetScout/NSConnect.py --connect $port1 $port2
			popd
EOF
	fi
}

# Get the latest driverctl package URLs

get_latest_driverctl()
{
	latest_build_id=$(curl -sL http://download.devel.redhat.com/brewroot/packages/driverctl | grep -B1 '<hr></pre>' | grep DIR | awk -F '"' '{print $6}' | tr -d '/')

	latest_el8_package_id=$(curl -sL http://download.devel.redhat.com/brewroot/packages/driverctl/$latest_build_id/ | grep el8 | head -n1 |  awk -F '"' '{print $6}' | tr -d '/')

	latest_el9_package_id=$(curl -sL http://download.devel.redhat.com/brewroot/packages/driverctl/$latest_build_id/ | grep el9 | tail -n1 |  awk -F '"' '{print $6}' | tr -d '/')

	el8_rpm=$(curl -sL http://download.devel.redhat.com/brewroot/packages/driverctl/$latest_build_id/$latest_el8_package_id/noarch/ | grep rpm | awk -F '"' '{print $6}')

	el9_rpm=$(curl -sL http://download.devel.redhat.com/brewroot/packages/driverctl/$latest_build_id/$latest_el9_package_id/noarch/ | grep rpm | awk -F '"' '{print $6}')

	export DRIVERCTL_RHEL8="http://download.devel.redhat.com/brewroot/packages/driverctl/$latest_build_id/$latest_el8_package_id/noarch/$el8_rpm"
	export DRIVERCTL_RHEL9="http://download.devel.redhat.com/brewroot/packages/driverctl/$latest_build_id/$latest_el9_package_id/noarch/$el9_rpm"
}

get_latest_driverctl

export RPM_DRIVERCTL=$DRIVERCTL_RHELRHEL_VER_MAJOR_VALUE
export RPM_OVS_TCPDUMP_PYTHON=$OVSFDP_STREAM_VALUE_PYTHON_FDP_RELEASE_VALUE_RHELRHEL_VER_MAJOR_VALUE
export RPM_OVS_TCPDUMP_TEST=$OVSFDP_STREAM_VALUE_TCPDUMP_FDP_RELEASE_VALUE_RHELRHEL_VER_MAJOR_VALUE

# RHEL composes

# if using a specific compose, first execute: export COMPOSE=<target compose id" in terminal window where you are executing the scripts to kick off tests
echo "Checking to see if a COMPOSE has been specified..."
if [[ -z $COMPOSE ]]; then
	/home/ralongi/github/tools/scripts/get_beaker_compose_id.sh $RHEL_VER && export COMPOSE=$(/home/ralongi/gvar/bin/gvar $latest_compose_id | awk -F "=" '{print $NF}')
fi

echo "Using compose: $COMPOSE"

get_zstream_repos

# Netperf package
export SRC_NETPERF="http://netqe-infra01.knqe.lab.eng.bos.redhat.com/share/tools/netperf-20210121.tar.bz2"

# VM image names
if [[ -z $VM_IMAGE ]]; then
	export VM_IMAGE="rhelRHEL_VER_VALUE.qcow2"
else
	export VM_IMAGE=$VM_IMAGE
fi

# OVS packages
if [[ -z $RPM_OVS ]]; then
	export RPM_OVS=$OVSFDP_STREAM_VALUE_FDP_RELEASE_VALUE_RHELRHEL_VER_MAJOR_VALUE
else
	export RPM_OVS=$RPM_OVS
fi

# OVN packages
if [[ -z $RPM_OVN_COMMON ]]; then
	if [[ $FDP_STREAM2 -gt 213 ]]; then
		export RPM_OVN_COMMON=$OVN_COMMON_YEAR_VALUE_FDP_RELEASE_VALUE_RHELRHEL_VER_MAJOR_VALUE
	else
		export RPM_OVN_COMMON=$OVN_COMMON_FDP_STREAM_VALUE_FDP_RELEASE_VALUE_RHELRHEL_VER_MAJOR_VALUE
	fi
else
	export RPM_OVN_COMMON=$RPM_OVN_COMMON
fi

if [[ -z $RPM_OVN_CENTRAL ]]; then
	if [[ $FDP_STREAM2 -gt 213 ]]; then
		export RPM_OVN_CENTRAL=$OVN_CENTRAL_YEAR_VALUE_FDP_RELEASE_VALUE_RHELRHEL_VER_MAJOR_VALUE
	else
		export RPM_OVN_CENTRAL=$OVN_CENTRAL_FDP_STREAM_VALUE_FDP_RELEASE_VALUE_RHELRHEL_VER_MAJOR_VALUE
	fi
else
	export RPM_OVN_CENTRAL=$RPM_OVN_CENTRAL
fi

if [[ -z $RPM_OVN_HOST ]]; then
	if [[ $FDP_STREAM2 -gt 213 ]]; then
		export RPM_OVN_HOST=$OVN_HOST_YEAR_VALUE_FDP_RELEASE_VALUE_RHELRHEL_VER_MAJOR_VALUE
	else
		export RPM_OVN_HOST=$OVN_HOST_FDP_STREAM_VALUE_FDP_RELEASE_VALUE_RHELRHEL_VER_MAJOR_VALUE
	fi
else
	export RPM_OVN_HOST=$RPM_OVN_HOST
fi

# SELinux packages
if [[ -z $RPM_OVS_SELINUX_EXTRA_POLICY ]]; then
	export RPM_OVS_SELINUX_EXTRA_POLICY=$OVS_SELINUX_FDP_RELEASE_VALUE_RHELRHEL_VER_MAJOR_VALUE
else
	export RPM_OVS_SELINUX_EXTRA_POLICY=$RPM_OVS_SELINUX_EXTRA_POLICY
fi

#DPDK packages

export RPM_DPDK_RHEL7=http://download.devel.redhat.com/brewroot/packages/dpdk/18.11.8/1.el7_8/x86_64/dpdk-18.11.8-1.el7_8.x86_64.rpm
export RPM_DPDK_TOOLS_RHEL7=http://download.devel.redhat.com/brewroot/packages/dpdk/18.11.8/1.el7_8/x86_64/dpdk-tools-18.11.8-1.el7_8.x86_64.rpm

if [[ $(echo $COMPOSE | grep RHEL-8.2) ]]; then
	export RPM_DPDK_RHEL8=http://download.devel.redhat.com/brewroot/packages/dpdk/19.11/5.el8_2/x86_64/dpdk-19.11-5.el8_2.x86_64.rpm
	export RPM_DPDK_TOOLS_RHEL8=http://download.devel.redhat.com/brewroot/packages/dpdk/19.11/5.el8_2/x86_64/dpdk-tools-19.11-5.el8_2.x86_64.rpm
elif [[ $(echo $COMPOSE | grep RHEL-8.3) ]]; then
	export RPM_DPDK_RHEL8=http://download.devel.redhat.com/brewroot/packages/dpdk/19.11.3/1.el8/x86_64/dpdk-19.11.3-1.el8.x86_64.rpm
	export RPM_DPDK_TOOLS_RHEL8=http://download.devel.redhat.com/brewroot/packages/dpdk/19.11.3/1.el8/x86_64/dpdk-tools-19.11.3-1.el8.x86_64.rpm
elif [[ $(echo $COMPOSE | grep RHEL-8.4) ]]; then
	export RPM_DPDK_RHEL8=http://download.devel.redhat.com/brewroot/packages/dpdk/20.11/3.el8/x86_64/dpdk-20.11-3.el8.x86_64.rpm
	export RPM_DPDK_TOOLS_RHEL8=http://download.devel.redhat.com/brewroot/packages/dpdk/20.11/3.el8/x86_64/dpdk-tools-20.11-3.el8.x86_64.rpm
# use 8.4 packages for RHEL-8.5 until updated info is available on https://errata.devel.redhat.com/package/show/dpdk
elif [[ $(echo $COMPOSE | grep RHEL-8.5) ]]; then
	export RPM_DPDK_RHEL8=http://download.devel.redhat.com/brewroot/packages/dpdk/20.11/3.el8/x86_64/dpdk-20.11-3.el8.x86_64.rpm
	export RPM_DPDK_TOOLS_RHEL8=http://download.devel.redhat.com/brewroot/packages/dpdk/20.11/3.el8/x86_64/dpdk-tools-20.11-3.el8.x86_64.rpm
elif [[ $(echo $COMPOSE | grep RHEL-8.6) ]]; then
	export RPM_DPDK_RHEL8=http://download.devel.redhat.com/brewroot/packages/dpdk/21.11/1.el8/x86_64/dpdk-21.11-1.el8.x86_64.rpm
	export RPM_DPDK_TOOLS_RHEL8=http://download.devel.redhat.com/brewroot/packages/dpdk/21.11/1.el8/x86_64/dpdk-tools-21.11-1.el8.x86_64.rpm
elif [[ $(echo $COMPOSE | grep RHEL-8) ]]; then
	export RPM_DPDK_RHEL8=http://download.devel.redhat.com/brewroot/packages/dpdk/20.11/3.el8/x86_64/dpdk-20.11-3.el8.x86_64.rpm
	export RPM_DPDK_TOOLS_RHEL8=http://download.devel.redhat.com/brewroot/packages/dpdk/20.11/3.el8/x86_64/dpdk-tools-20.11-3.el8.x86_64.rpm
elif [[ $(echo $COMPOSE | grep RHEL-9) ]]; then
	export RPM_DPDK_RHEL9=http://download.devel.redhat.com/brewroot/packages/dpdk/21.11/1.el9_0/x86_64/dpdk-21.11-1.el9_0.x86_64.rpm
	export RPM_DPDK_TOOLS_RHEL9=http://download.devel.redhat.com/brewroot/packages/dpdk/21.11/1.el9_0/x86_64/dpdk-tools-21.11-1.el9_0.x86_64.rpm
fi

# For rpm_dpdk variable used by openvswitch/perf tests
export rpm_dpdk=$RPM_DPDK_RHELRHEL_VER_MAJOR_VALUE
export rpm_dpdk_tools=$RPM_DPDK_TOOLS_RHELRHEL_VER_MAJOR_VALUE
export RPM_DPDK=$RPM_DPDK_RHELRHEL_VER_MAJOR_VALUE
export RPM_DPDK_TOOLS=$RPM_DPDK_TOOLS_RHELRHEL_VER_MAJOR_VALUE


# QEMU packages
#export QEMU_KVM_RHEV_RHEL7=http://download.devel.redhat.com/brewroot/packages/qemu-kvm-rhev/2.12.0/48.el7_9.2/x86_64/qemu-kvm-rhev-2.12.0-48.el7_9.2.x86_64.rpm

# OVN packages
export RPM_OVN=$OVNFDP_STREAM_VALUE_FDP_RELEASE_VALUE_RHELRHEL_VER_MAJOR_VALUE 

export BONDING_TESTS="ovs_test_bond_active_backup ovs_test_bond_set_active_slave ovs_test_bond_lacp_active ovs_test_bond_lacp_passive ovs_test_bond_balance_slb ovs_test_bond_balance_tcp"

export BONDING_CPU_TESTS="ovs_test_bond_active_backup ovs_test_bond_set_active_slave ovs_test_bond_lacp_active ovs_test_bond_lacp_passive ovs_test_bond_balance_slb ovs_test_bond_balance_tcp ovs_test_ns_enable_nomlockall_CPUAffinity_test"

export GRE_IPV6_TESTS="ovs_test_gre_ipv6 ovs_test_gre1_ipv6 ovs_test_gre_flow_ipv6 ovs_test_vlan_gre_ipv6 ovs_test_vlan_gre1_ipv6 ovs_test_vm_gre_ipv6 ovs_test_vm_gre1_ipv6 ovs_test_vm_gre_flow_ipv6 ovs_test_vm_vlan_gre_ipv6 ovs_test_vm_vlan_gre1_ipv6"

#pushd /home/ralongi/Documents/ovs_testing
#pushd /home/ralongi/global_docs/ovs_testing
pushd /home/ralongi/github/tools/ovs_testing

#./exec_mcast_snoop.sh
#./exec_ovs_qos.sh
#./exec_forward_bpdu.sh
#./exec_of_rules.sh
#./exec_power_cycle_crash.sh
#./exec_ovs_upgrade.sh
# To run just the ovs_test_ns_enable_nomlockall_CPUAffinity_test for topo, add "cpu" to the string of arguments
#./exec_topo.sh ixgbe
#./exec_topo.sh i40e
#./exec_topo.sh ice
#./exec_topo.sh mlx5_core cx5
#./exec_topo.sh mlx5_core cx6
#./exec_topo.sh arm
#./exec_topo.sh mlx5_core cx7
#./exec_endurance.sh cx6
#./exec_perf_ci.sh cx6

#./exec_topo.sh enic
#./exec_topo.sh qede
#./exec_topo.sh bnxt_en
#./exec_topo.sh nfp
#./exec_sanity_check.sh

#./exec_ovs_memory_leak_soak.sh
#./exec_ovn_memory_leak_soak.sh

#./exec_regression_bug.sh

###############################################################################
#export VM_IMAGE=http://netqe-infra01.knqe.lab.eng.bos.redhat.com/share/vms/OVS/rhelRHEL_VER_VALUE.qcow2
#./exec_endurance.sh cx5
#./exec_perf_ci.sh cx5
#./exec_perf_ci_pensando_sriov.sh
#export VM_IMAGE="rhelRHEL_VER_VALUE.qcow2"
###############################################################################

# Conntrack firewall rules Jiying Qiu (not related to driver)
# openvswitch/conntrack2 and openvswitch/conntrack_dpdk
#./exec_conntrack2.sh
#./exec_conntrack_dpdk.sh

# Stateful traffic Xena (by speed)
# openvswitch/conntrack3/ct_kernel and openvswitch/conntrack3/ct_userspace
# Google sheet: https://docs.google.com/spreadsheets/d/1cPG1ovmrCo1RhAMGVfK9SgKIEtj7yocjYP_CDvLUfYY/edit?usp=sharing
#./exec_ct_kernel.sh
#./exec_ct_userspace.sh

# ovs-dpdk-conntrack
# Google sheet: https://docs.google.com/spreadsheets/d/17MKqKpCmVV93dhCawgD-xxAm3aQweV5yszb82A-L-Kk/edit?usp=sharing
# search for "disable emc" and then "enable emc" in taskout.log file
#./exec_ovs_dpdk_conntrack.sh

# ovs-kernel-conntrack
# Google sheet: https://docs.google.com/spreadsheets/d/1qku7ViuVgAwWXobQjekv1JxNvfQ4rgjCOBX0NTeda9o/edit?usp=sharing
# search for "disable emc" and then "enable emc" in taskout.log file
#./exec_ovs_kernel_conntrack.sh

# ovs-dpdk-latency
# Google sheet: https://docs.google.com/spreadsheets/d/11BqpCkXoUXTVH4s0uMGZ4ieBOZzUNjbYS9E-3CxYIpI/edit?usp=sharing
# search for "Flows:" in taskout.log file
#./exec_ovs_dpdk_latency.sh

# xena_conntrack/xena_dpdk
#./exec_xena_dpdk.sh

### may need to add vm_100

#echo "FDP_STREAM2 is now set to $FDP_STREAM2"
echo "COMPOSE is: $COMPOSE"
echo "FDP Release is: $FDP_RELEASE"
echo "FDP Stream is: $FDP_STREAM"
echo "RPM_OVS: $RPM_OVS"
echo "RPM_OVN_CENTRAL: $RPM_OVN_CENTRAL"
echo "RPM_OVN_HOST: $RPM_OVN_HOST"
echo "RPM_OVN_COMMON: $RPM_OVN_COMMON"
echo "RPM_OVN_CENTRAL: $RPM_OVN_CENTRAL"
echo "RPM_OVN_HOST: $RPM_OVN_HOST"

popd
